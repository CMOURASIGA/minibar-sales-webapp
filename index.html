<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minibar EAC - Controle de Vendas</title>
    <meta name="theme-color" content="#1e4d72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Minibar EAC">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e4d72 0%, #2d5f8a 50%, #3a6f9a 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .container { max-width: 420px; width: 100%; margin: 0 auto; padding: 10px; min-height: 100vh; }
        .header { text-align: center; margin-bottom: 15px; background: rgba(255, 255, 255, 0.98); padding: 15px 10px; border-radius: 20px; box-shadow: 0 10px 40px rgba(30, 77, 114, 0.3); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.2); }
        .logo { width: 80px; height: 80px; margin: 0 auto 10px; background: linear-gradient(135deg, #1e4d72 0%, #dc143c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid #dc143c; position: relative; overflow: hidden; }
        .logo-image { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        h1 { color: #1e4d72; font-size: 18px; margin-bottom: 5px; font-weight: 700; }
        .subtitle { color: #dc143c; font-size: 11px; font-weight: 600; line-height: 1.3; }
        .screen { background: rgba(255, 255, 255, 0.98); padding: 15px; border-radius: 20px; box-shadow: 0 10px 40px rgba(30, 77, 114, 0.3); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.2); margin-bottom: 10px; width: 100%; }
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 14px 16px; margin: 8px 0; background: linear-gradient(135deg, #1e4d72 0%, #2d5f8a 100%); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 25px rgba(30, 77, 114, 0.4); position: relative; overflow: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 50px; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); box-shadow: 0 6px 25px rgba(108, 117, 125, 0.4); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #dc143c 0%, #c82333 100%); box-shadow: 0 6px 25px rgba(220, 20, 60, 0.4); }
        .btn-register { background: linear-gradient(135deg, #dc143c 0%, #a01020 100%); box-shadow: 0 6px 25px rgba(220, 20, 60, 0.4); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #1e4d72; font-size: 13px; }
        input, select { width: 100%; padding: 12px 14px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; background: white; color: #333; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        input:focus, select:focus { outline: none; border-color: #1e4d72; box-shadow: 0 0 0 3px rgba(30, 77, 114, 0.1); }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 10px center; background-repeat: no-repeat; background-size: 14px; padding-right: 35px; }
        .alert { padding: 12px; margin: 10px 0; border-radius: 12px; font-weight: 500; border: none; animation: slideIn 0.3s ease; font-size: 14px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .alert-success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border-left: 4px solid #28a745; }
        .alert-error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border-left: 4px solid #dc143c; }
        .total-section { background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center; border: 2px solid #28a745; box-shadow: 0 5px 20px rgba(40, 167, 69, 0.2); }
        .total-amount { font-size: 22px; font-weight: bold; color: #28a745; }
        .history-item, .product-list-item, .customer-list-item { background: linear-gradient(135deg, white 0%, #f8f9fa 100%); padding: 12px; margin: 8px 0; border-radius: 12px; border: 2px solid #e9ecef; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .history-date { font-size: 11px; color: #6c757d; margin-bottom: 5px; font-weight: 600; }
        .loading { text-align: center; padding: 20px; color: #1e4d72; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1e4d72; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .back-btn { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; margin-bottom: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); transition: all 0.2s ease; font-size: 13px; }
        .customer-form, .product-form { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #1e4d72; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { background: linear-gradient(135deg, white 0%, #f8f9fa 100%); padding: 12px; border-radius: 12px; text-align: center; border: 2px solid #e9ecef; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .stat-number { font-size: 18px; font-weight: bold; color: #1e4d72; }
        .stat-label { font-size: 10px; color: #666; margin-top: 3px; }
        h2 { font-size: 16px; color: #1e4d72; margin-bottom: 15px; }
        h3 { font-size: 14px; color: #1e4d72; margin: 15px 0 8px 0; }
        .btn-mark-paid { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .email-receipt-form { background: #e3f2fd; padding: 15px; border-radius: 12px; margin-top: 20px; border: 2px solid #1e4d72; }
        .product-list-item, .customer-list-item { display: flex; align-items: center; justify-content: space-between; }
        .product-info, .customer-info { flex-grow: 1; }
        .product-name, .customer-name { font-weight: 600; }
        .product-price, .customer-phone { color: #28a745; font-weight: bold; }
        .product-actions, .customer-actions, .history-item-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
        .product-actions button, .customer-actions button, .history-item-actions button { padding: 5px 8px; font-size: 11px; margin-left: 5px; min-height: auto; width: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo"><img src="https://i.imgur.com/c5XQ7TW.png" alt="Minibar EAC Logo" class="logo-image"></div>
            <h1>Minibar EAC</h1>
            <div class="subtitle">Sede fortes e corajosos - Firmes na f√©, unidos no amor</div>
        </div>

        <!-- Telas -->
        <div id="homeScreen" class="screen">
            <button class="btn" onclick="showRegisterScreen()">üõí Registrar Compra</button>
            <button class="btn btn-secondary" onclick="showHistoryScreen()">üìä Consultar Hist√≥rico</button>
            <button class="btn btn-register" onclick="showCustomerScreen()">üë§ Gerenciar Clientes</button>
            <button class="btn" onclick="showProductScreen()">üîß Gerenciar Produtos</button>
            <button class="btn btn-success" onclick="showReportsScreen()">üìà Relat√≥rios de Vendas</button>
        </div>

        <div id="customerScreen" class="screen hidden">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Voltar</button>
            <h2>Gerenciar Clientes</h2>
            <div id="customerFormContainer" class="customer-form hidden">
                <form id="customerForm">
                    <h3 id="customerFormTitle">Adicionar Cliente</h3>
                    <input type="hidden" id="originalCustomerPhone">
                    <div class="form-group">
                        <label for="customerNameField">Nome do Cliente</label>
                        <input type="text" id="customerNameField">
                    </div>
                    <div class="form-group">
                        <label for="customerPhoneField">Telefone</label>
                        <input type="tel" id="customerPhoneField" oninput="formatPhone(this)" maxlength="13">
                    </div>
                </form>
                <div id="customerAlert"></div>
                <button class="btn btn-success" onclick="saveCustomer()">Salvar Cliente</button>
                <button class="btn btn-secondary" onclick="hideCustomerForm()">Cancelar</button>
            </div>
            <button class="btn" onclick="showCustomerForm()">‚ûï Adicionar Novo Cliente</button>
            <h3>Lista de Clientes</h3>
            <div id="customerList"><div class="loading"><div class="spinner"></div>Carregando...</div></div>
        </div>

        <div id="productScreen" class="screen hidden">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Voltar</button>
            <h2>Gerenciar Produtos</h2>
            <div id="productFormContainer" class="product-form hidden">
                <form id="productForm">
                    <h3 id="productFormTitle">Adicionar Produto</h3>
                    <input type="hidden" id="productId">
                    <div class="form-group"><label for="productName">Nome do Produto</label><input type="text" id="productName"></div>
                    <div class="form-group"><label for="productValue">Valor (R$)</label><input type="number" id="productValue" step="0.01"></div>
                </form>
                <div id="productAlert"></div>
                <button class="btn btn-success" onclick="saveProduct()">Salvar Produto</button>
                <button class="btn btn-secondary" onclick="hideProductForm()">Cancelar</button>
            </div>
            <button class="btn" onclick="showProductForm()">‚ûï Adicionar Novo Produto</button>
            <h3>Lista de Produtos</h3>
            <div id="productList"><div class="loading"><div class="spinner"></div>Carregando...</div></div>
        </div>

        <div id="registerScreen" class="screen hidden">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Voltar</button>
            <h2>Registrar Compra</h2>
            <form id="registerForm">
                <div class="form-group"><label for="phoneInput">Telefone do Cliente</label><input type="tel" id="phoneInput" oninput="handlePhoneInput(this)" maxlength="13"></div>
                <div class="form-group"><label for="customerName">Nome do Cliente</label><input type="text" id="customerName" readonly></div>
                <h3>Adicionar Produto</h3>
                <div class="form-group"><label for="productSelect">Produto</label><select id="productSelect"><option value="">Carregando...</option></select></div>
                <div class="form-group"><label for="quantityInput">Quantidade</label><input type="number" id="quantityInput" min="1" value="1"></div>
            </form>
            <button class="btn" onclick="addToCart()">‚ûï Adicionar ao Carrinho</button>
            <div id="registerAlert"></div>
            <h3>Carrinho de Compras</h3>
            <div id="cartItems"></div>
            <div class="form-group" style="margin-top: 15px; display: flex; align-items: center; justify-content: center; background-color: #e3f2fd; padding: 10px; border-radius: 10px;">
                <input type="checkbox" id="isPaidCheckbox" style="width: auto; height: 18px; margin-right: 10px; appearance: auto;">
                <label for="isPaidCheckbox" style="margin-bottom: 0; font-weight: 600; color: #1e4d72;">Marcar como Paga</label>
            </div>
            <button class="btn btn-success" onclick="finalizePurchase()" id="finalizePurchaseBtn" style="display: none;">üõí Finalizar Compra</button>
        </div>

        <div id="historyScreen" class="screen hidden">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Voltar</button>
            <h2>Hist√≥rico de Compras</h2>
            <form id="historyForm">
                <div class="form-group"><label for="historyPhoneInput">Telefone do Cliente</label><input type="tel" id="historyPhoneInput" oninput="formatPhone(this)" maxlength="13"></div>
            </form>
            <button class="btn" onclick="searchHistory()">üîç Buscar Hist√≥rico</button>
            <div id="historyResults"></div>
            <div id="emailReceiptSection" class="email-receipt-form hidden">
                <h3>Enviar Recibo por E-mail</h3>
                <div class="form-group"><label for="receiptEmail">E-mail do Cliente</label><input type="email" id="receiptEmail"></div>
                <button class="btn btn-success" onclick="sendEmailReceipt()">‚úâÔ∏è Enviar Recibo</button>
                <div id="emailAlert"></div>
            </div>
        </div>

        <div id="reportsScreen" class="screen hidden">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Voltar</button>
            <h2>Relat√≥rios de Vendas</h2>
            <div class="form-group"><label for="reportStartDate">Data Inicial</label><input type="text" id="reportStartDate" placeholder="DD/MM/AAAA" maxlength="10" oninput="maskDate(this)"></div>
            <div class="form-group"><label for="reportEndDate">Data Final</label><input type="text" id="reportEndDate" placeholder="DD/MM/AAAA" maxlength="10" oninput="maskDate(this)"></div>
            <button class="btn btn-success" onclick="generateReport()">üìä Gerar Relat√≥rio</button>
            <div id="reportResults"></div>
        </div>
    </div>

    <script>
        let products = [], customers = [], cart = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            const today = new Date();
            const thirtyDaysAgo = new Date(new Date().setDate(today.getDate() - 30));
            document.getElementById('reportStartDate').value = thirtyDaysAgo.toLocaleDateString('pt-BR');
            document.getElementById('reportEndDate').value = today.toLocaleDateString('pt-BR');
        });

        const hideAllScreens = () => document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        const showScreen = id => { hideAllScreens(); document.getElementById(id).classList.remove('hidden'); };

        function showHomeScreen() { showScreen('homeScreen'); loadInitialData(); }
        function showRegisterScreen() { showScreen('registerScreen'); clearRegisterForm(); }
        function showHistoryScreen() { showScreen('historyScreen'); clearHistoryForm(); }
        function showReportsScreen() { showScreen('reportsScreen'); clearReportResults(); }
        function showProductScreen() { showScreen('productScreen'); loadProductsToManage(); }
        function showCustomerScreen() { showScreen('customerScreen'); loadCustomersToManage(); }

        function clearRegisterForm() { document.getElementById('registerAlert').innerHTML = ''; document.getElementById('registerForm').reset(); cart = []; updateCartDisplay(); }
        function clearHistoryForm() { document.getElementById('historyResults').innerHTML = ''; document.getElementById('emailReceiptSection').classList.add('hidden'); document.getElementById('historyForm').reset(); }
        function clearReportResults() { document.getElementById('reportResults').innerHTML = ''; }
        
        function clearProductForm() {
            document.getElementById('productAlert').innerHTML = '';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productFormTitle').textContent = 'Adicionar Produto';
        }
        
        function clearCustomerForm() {
            document.getElementById('customerAlert').innerHTML = '';
            document.getElementById('customerForm').reset();
            document.getElementById('originalCustomerPhone').value = '';
            document.getElementById('customerFormTitle').textContent = 'Adicionar Cliente';
            document.getElementById('customerPhoneField').disabled = false;
        }

        const formatPhone = input => { let v = input.value.replace(/\D/g, ''); if (v.length === 11 && !v.startsWith('55')) v = '55' + v; input.value = v.substring(0, 13); };

        function loadInitialData() {
            google.script.run.withSuccessHandler(data => { products = data || []; loadProductsToSelect(); }).getProducts();
            google.script.run.withSuccessHandler(data => { customers = data || []; }).getCustomers();
        }

        function loadProductsToSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Selecione um produto</option>';
            products.forEach(p => select.add(new Option(`${p.nome} - R$ ${p.valor.toFixed(2)}`, p.id)));
        }

        // --- Gerenciamento de Clientes ---
        function loadCustomersToManage() {
            const listDiv = document.getElementById('customerList');
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Carregando...</div>';
            google.script.run.withSuccessHandler(data => {
                customers = data || [];
                listDiv.innerHTML = customers.length === 0 ? '<p>Nenhum cliente cadastrado.</p>' : customers.map(c => `
                    <div class="customer-list-item">
                        <div class="customer-info">
                            <div class="customer-name">${c.nome}</div>
                            <div class="customer-phone">${c.telefone}</div>
                        </div>
                        <div class="customer-actions">
                            <button class="btn btn-secondary" onclick="editCustomer('${c.telefone}', '${c.nome}')">Editar</button>
                            <button class="btn btn-danger" onclick="confirmDeleteCustomer(this, '${c.telefone}')">Excluir</button>
                        </div>
                    </div>`).join('');
            }).withFailureHandler(() => listDiv.innerHTML = '<div class="alert alert-error">Erro ao carregar clientes.</div>').getCustomers();
        }
        function showCustomerForm() { clearCustomerForm(); document.getElementById('customerFormContainer').classList.remove('hidden'); }
        function hideCustomerForm() { document.getElementById('customerFormContainer').classList.add('hidden'); clearCustomerForm(); }
        function editCustomer(phone, name) {
            document.getElementById('customerFormContainer').classList.remove('hidden');
            document.getElementById('customerFormTitle').textContent = 'Editar Cliente';
            document.getElementById('originalCustomerPhone').value = phone;
            document.getElementById('customerNameField').value = name;
            document.getElementById('customerPhoneField').value = phone;
            document.getElementById('customerPhoneField').disabled = true;
            window.scrollTo(0, 0);
        }
        function saveCustomer() {
            const name = document.getElementById('customerNameField').value.trim();
            const phone = document.getElementById('customerPhoneField').value.trim();
            const originalPhone = document.getElementById('originalCustomerPhone').value;
            if (!name || !phone) return showAlert('customerAlert', 'Nome e telefone s√£o obrigat√≥rios.', 'error');
            
            const btn = event.target;
            btn.disabled = true;
            const operation = originalPhone ? 'updateCustomer' : 'addCustomer';
            const data = { nome: name, telefone: originalPhone || phone };

            google.script.run.withSuccessHandler(result => {
                if (result.success) { hideCustomerForm(); loadCustomersToManage(); } 
                else { showAlert('customerAlert', result.message, 'error'); }
                btn.disabled = false;
            }).withFailureHandler(() => { showAlert('customerAlert', 'Erro ao salvar cliente.', 'error'); btn.disabled = false; })[operation](data);
        }
        function confirmDeleteCustomer(btn, phone) {
            if (confirm('Tem certeza? Se o cliente tiver compras, ele n√£o ser√° exclu√≠do.')) {
                btn.disabled = true;
                google.script.run.withSuccessHandler(result => {
                    if (result.success) { loadCustomersToManage(); } 
                    else { alert(result.message); btn.disabled = false; }
                }).withFailureHandler(() => { alert('Erro ao excluir.'); btn.disabled = false; }).deleteCustomer(phone);
            }
        }

        // --- Gerenciamento de Produtos ---
        function loadProductsToManage() {
            const listDiv = document.getElementById('productList');
            listDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Carregando...</div>';
            google.script.run.withSuccessHandler(data => {
                products = data || [];
                listDiv.innerHTML = products.length === 0 ? '<p>Nenhum produto cadastrado.</p>' : products.map(p => `
                    <div class="product-list-item">
                        <div class="product-info">
                            <div class="product-name">${p.nome}</div>
                            <div class="product-price">R$ ${p.valor.toFixed(2)}</div>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-secondary" onclick="editProduct(${p.id}, '${p.nome}', ${p.valor})">Editar</button>
                            <button class="btn btn-danger" onclick="confirmDeleteProduct(this, ${p.id})">Excluir</button>
                        </div>
                    </div>`).join('');
            }).withFailureHandler(() => listDiv.innerHTML = '<div class="alert alert-error">Erro ao carregar produtos.</div>').getProducts();
        }
        function showProductForm() { clearProductForm(); document.getElementById('productFormContainer').classList.remove('hidden'); }
        function hideProductForm() { document.getElementById('productFormContainer').classList.add('hidden'); clearProductForm(); }
        function editProduct(id, name, value) {
            document.getElementById('productFormContainer').classList.remove('hidden');
            document.getElementById('productFormTitle').textContent = 'Editar Produto';
            document.getElementById('productId').value = id;
            document.getElementById('productName').value = name;
            document.getElementById('productValue').value = value;
            window.scrollTo(0, 0);
        }
        function saveProduct() {
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value.trim();
            const value = parseFloat(document.getElementById('productValue').value);
            if (!name || !value || value <= 0) return showAlert('productAlert', 'Nome e valor v√°lidos s√£o obrigat√≥rios.', 'error');
            
            const btn = event.target;
            btn.disabled = true;
            const operation = id ? 'updateProduct' : 'addProduct';
            google.script.run.withSuccessHandler(result => {
                if (result.success) { hideProductForm(); loadProductsToManage(); } 
                else { showAlert('productAlert', result.message, 'error'); }
                btn.disabled = false;
            }).withFailureHandler(() => { showAlert('productAlert', 'Erro ao salvar.', 'error'); btn.disabled = false; })[operation]({ id, nome: name, valor: value });
        }
        function confirmDeleteProduct(btn, id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                btn.disabled = true;
                google.script.run.withSuccessHandler(result => {
                    if (result.success) { loadProductsToManage(); } 
                    else { alert(result.message); btn.disabled = false; }
                }).withFailureHandler(() => { alert('Erro ao excluir.'); btn.disabled = false; }).deleteProduct(id);
            }
        }

        // --- Registro de Compra ---
        function handlePhoneInput(input) {
            formatPhone(input);
            const phone = input.value.trim();
            const nameInput = document.getElementById('customerName');
            if (phone.length < 13) nameInput.value = '';
            if (phone.length === 13 && nameInput.value === '') {
                google.script.run.withSuccessHandler(c => {
                    if(c) { nameInput.value = c.nome; showAlert('registerAlert', `Cliente encontrado: ${c.nome}`, 'success'); }
                    else { showAlert('registerAlert', 'Cliente n√£o encontrado.', 'error'); }
                }).getCustomerByPhone(phone);
            }
        }
        function addToCart() {
            const productId = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (!productId || !quantity || quantity <= 0) return showAlert('registerAlert', 'Selecione um produto e quantidade v√°lida.', 'error');
            const product = products.find(p => p.id == productId);
            if (!product) return showAlert('registerAlert', 'Produto n√£o encontrado.', 'error');
            const existingItem = cart.find(item => item.productId == productId);
            if (existingItem) { existingItem.quantity += quantity; } 
            else { cart.push({ productId: product.id, productName: product.nome, quantity, unitPrice: product.valor }); }
            updateCartDisplay();
        }
        function updateCartDisplay() {
            const cartContainer = document.getElementById('cartItems');
            document.getElementById('finalizePurchaseBtn').style.display = cart.length > 0 ? 'block' : 'none';
            if (cart.length === 0) return cartContainer.innerHTML = '<p>Carrinho vazio</p>';
            let total = 0;
            cartContainer.innerHTML = cart.map((item, index) => {
                item.subtotal = item.quantity * item.unitPrice;
                total += item.subtotal;
                return `<div class="history-item" style="display:flex; align-items:center;">
                            <div style="flex-grow:1;">${item.productName}<br><small>Qtd: ${item.quantity} x R$ ${item.unitPrice.toFixed(2)} = R$ ${item.subtotal.toFixed(2)}</small></div>
                            <button class="btn btn-danger" style="padding:5px 8px; font-size:11px; min-height:auto; width:auto;" onclick="removeFromCart(${index})">Remover</button>
                        </div>`;
            }).join('') + `<div class="total-section">Total: <span class="total-amount">R$ ${total.toFixed(2)}</span></div>`;
        }
        function removeFromCart(index) { cart.splice(index, 1); updateCartDisplay(); }
        function finalizePurchase() {
            const phone = document.getElementById('phoneInput').value.trim();
            if (!phone || !document.getElementById('customerName').value || cart.length === 0) return showAlert('registerAlert', 'Verifique o telefone, cliente e carrinho.', 'error');
            const btn = event.target;
            btn.disabled = true;
            google.script.run.withSuccessHandler(result => {
                if (result.success) { showAlert('registerAlert', '‚úÖ Compra registrada!', 'success'); setTimeout(() => showHomeScreen(), 2000); } 
                else { showAlert('registerAlert', `‚ùå ${result.message}`, 'error'); }
                btn.disabled = false;
            }).withFailureHandler(() => { showAlert('registerAlert', 'Erro ao registrar.', 'error'); btn.disabled = false; })
            .registerPurchase({ telefone: phone, items: cart, pago: document.getElementById('isPaidCheckbox').checked });
        }

        // --- Hist√≥rico e Pagamentos ---
        function searchHistory() {
            const phone = document.getElementById('historyPhoneInput').value.trim();
            if (!phone) return;
            const resultsDiv = document.getElementById('historyResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Carregando...</div>';
            document.getElementById('emailReceiptSection').classList.add('hidden');
            google.script.run.withSuccessHandler(purchases => {
                if (purchases.length === 0) return resultsDiv.innerHTML = '<div class="alert alert-error">Nenhuma compra encontrada.</div>';
                document.getElementById('emailReceiptSection').classList.remove('hidden');
                let totalGeral = 0, totalPago = 0, totalPendente = 0;
                const grouped = purchases.reduce((acc, p) => { (acc[p.data] = acc[p.data] || []).push(p); return acc; }, {});
                let historyHTML = '<h3>Hist√≥rico de Compras:</h3>' + Object.keys(grouped).map(dataISO => {
                    const items = grouped[dataISO];
                    const first = items[0];
                    const groupSubtotal = items.reduce((sum, i) => sum + i.subtotal, 0);
                    totalGeral += groupSubtotal;
                    first.status === 'Pago' ? totalPago += groupSubtotal : totalPendente += groupSubtotal;
                    const statusStyle = first.status === 'Pago' ? 'color:#28a745;background-color:#d4edda;border:1px solid #28a745;' : 'color:#721c24;background-color:#f8d7da;border:1px solid #dc143c;';
                    return `<div class="history-item">
                                <div class="history-date">${new Date(dataISO).toLocaleString('pt-BR')} - <span style="font-weight:bold;padding:2px 6px;border-radius:8px;font-size:10px;${statusStyle}">${first.status}</span></div>
                                <ul style="list-style-position:inside;padding-left:5px;font-size:14px;">${items.map(i => `<li>${i.produto} (Qtd: ${i.quantidade}) - R$ ${i.subtotal.toFixed(2)}</li>`).join('')}</ul>
                                <div style="text-align:right;font-weight:bold;margin-top:5px;">Subtotal: R$ ${groupSubtotal.toFixed(2)}</div>
                                <div class="history-item-actions">
                                    ${first.status === 'Pendente' ? `<button class="btn-mark-paid" onclick="markAsPaid(this, '${first.telefone}', '${dataISO}')">Marcar como Pago</button>` : ''}
                                    <button class="btn btn-danger" onclick="confirmDeletePurchase(this, '${first.telefone}', '${dataISO}')">Excluir</button>
                                </div>
                            </div>`;
                }).join('');
                historyHTML += `<div class="total-section">Total Geral: <span class="total-amount">R$ ${totalGeral.toFixed(2)}</span></div>
                              <div class="stats-grid">
                                  <div class="stat-card"><div class="stat-number" style="color:#28a745;">R$ ${totalPago.toFixed(2)}</div><div class="stat-label">Total Pago</div></div>
                                  <div class="stat-card"><div class="stat-number" style="color:#dc143c;">R$ ${totalPendente.toFixed(2)}</div><div class="stat-label">Total Pendente</div></div>
                              </div>`;
                resultsDiv.innerHTML = historyHTML;
            }).withFailureHandler(() => resultsDiv.innerHTML = '<div class="alert alert-error">Erro ao buscar hist√≥rico.</div>').getPurchaseHistory(phone);
        }
        function markAsPaid(btn, telefone, dataISO) {
            btn.disabled = true;
            google.script.run.withSuccessHandler(r => { if(r.success) searchHistory(); else { alert(r.message); btn.disabled = false; } }).markPurchaseAsPaid({ telefone, dataISO });
        }
        function confirmDeletePurchase(btn, telefone, dataISO) {
            if (confirm('Tem certeza que deseja EXCLUIR este registro de compra? Esta a√ß√£o √© irrevers√≠vel.')) {
                btn.disabled = true;
                google.script.run.withSuccessHandler(r => {
                    if (r.success) { searchHistory(); } 
                    else { alert(r.message); btn.disabled = false; }
                }).withFailureHandler(() => { alert('Erro ao excluir compra.'); btn.disabled = false; }).deletePurchase({ telefone, dataISO });
            }
        }
        function sendEmailReceipt() {
            const phone = document.getElementById('historyPhoneInput').value.trim();
            const email = document.getElementById('receiptEmail').value.trim();
            if (!email || !email.includes('@')) return showAlert('emailAlert', 'E-mail inv√°lido.', 'error');
            const btn = event.target;
            btn.disabled = true;
            google.script.run.withSuccessHandler(r => {
                showAlert('emailAlert', r.message, r.success ? 'success' : 'error');
                if(r.success) document.getElementById('receiptEmail').value = '';
                btn.disabled = false;
            }).withFailureHandler(() => { showAlert('emailAlert', 'Erro ao enviar.', 'error'); btn.disabled = false; }).sendPurchaseHistoryEmail(phone, email);
        }

        // --- Relat√≥rios ---
        function generateReport() {
            const rawStart = document.getElementById('reportStartDate').value;
            const rawEnd = document.getElementById('reportEndDate').value;
            const startDate = parseDateBRtoISO(rawStart);
            const endDate = parseDateBRtoISO(rawEnd);

            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                return showAlert('reportResults', 'Per√≠odo de datas inv√°lido.', 'error');
            }

            const resultsDiv = document.getElementById('reportResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Gerando...</div>';
            google.script.run.withSuccessHandler(report => {
                if (report.erro) return resultsDiv.innerHTML = `<div class="alert alert-error">Erro: ${report.erro}</div>`;
                
                let html = `<h3>Relat√≥rio de Vendas</h3><div class="alert alert-success">Per√≠odo: ${rawStart} a ${rawEnd}</div>
                            <div class="stats-grid">
                                <div class="stat-card"><div class="stat-number" style="color:#28a745;">R$ ${report.totalPago.toFixed(2)}</div><div class="stat-label">Total Pago</div></div>
                                <div class="stat-card"><div class="stat-number" style="color:#dc143c;">R$ ${report.totalPendente.toFixed(2)}</div><div class="stat-label">Total Pendente</div></div>
                            </div>
                            <div class="total-section" style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-color:#1e4d72;">
                                <div>Faturamento Total: <span class="total-amount" style="color:#1e4d72;">R$ ${report.totalGeral.toFixed(2)}</span></div>
                            </div>`;
                if (report.vendas.length > 0) {
                    html += '<h3>Vendas Detalhadas:</h3>' + report.vendas.map(sale => {
                        const statusStyle = sale.status === 'Pago' ? 'color:#28a745;background-color:#d4edda;border:1px solid #28a745;' : 'color:#721c24;background-color:#f8d7da;border:1px solid #dc143c;';
                        return `<div class="history-item">
                                    <div class="history-date">${new Date(sale.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - <span style="font-weight:bold;padding:2px 6px;border-radius:8px;font-size:10px;${statusStyle}">${sale.status}</span></div>
                                    <div><strong>${sale.produto}</strong></div>
                                    <div>Cliente: ${sale.nome} (${sale.telefone})</div>
                                    <div><strong>Subtotal: R$ ${sale.subtotal.toFixed(2)}</strong></div>
                                </div>`;
                    }).join('');
                } else {
                    html += `<div class="alert alert-error">Nenhuma venda encontrada no per√≠odo.</div>`;
                }
                resultsDiv.innerHTML = html;
            }).withFailureHandler(() => resultsDiv.innerHTML = `<div class="alert alert-error">Erro ao gerar relat√≥rio.</div>`).getSalesReport(startDate, endDate);
        }

        function parseDateBRtoISO(dateStr) {
            if (!dateStr || dateStr.length !== 10) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const [day, month, year] = parts;
            if (isNaN(day) || isNaN(month) || isNaN(year) || day < 1 || day > 31 || month < 1 || month > 12 || year < 1900) return null;
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }

        function maskDate(input) {
            let v = input.value.replace(/\D/g, '').substring(0, 8);
            if (v.length >= 5) {
                input.value = v.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
            } else if (v.length >= 3) {
                input.value = v.replace(/(\d{2})(\d{1,2})/, '$1/$2');
            } else {
                input.value = v;
            }
        }

        const showAlert = (id, msg, type) => {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            if (type === 'success') setTimeout(() => { if (el.innerHTML.includes(msg)) el.innerHTML = ''; }, 5000);
        };
    </script>
</body>
</html>
